# SONSHIガチャ 機能一覧

## 1. 基本ガチャ機能（UMA ROYALEベース）

UMA ROYALE（../umagacha）のガチャ機能を参考に実装。

- シングルガチャ（1回）
- チケット購入（one.lat決済）
- ガチャ演出映像再生（映像+音声分離方式）
- 結果表示（デジタルカード）

## 2. 連続ガチャ（新機能・最重要）

2連・5連・10連ガチャを実装する。

### 【最重要】自動で連続再生するのではない

参考: DMMパチタウンの「ハラキリチャンス」
https://p-town.dmm.com/specials/2840

### 仕組み

1. ユーザーが「10連ガチャ」を選択、チケット10枚消費
2. サーバー側で10回分の結果を事前に全て決定する
3. 10回分の結果に基づいて、演出シナリオを組み立てる
4. ユーザーに1回目の演出映像を表示
5. 映像終了後、「NEXT」ボタンが表示される
6. ユーザーがボタンを押すと、2回目の演出映像が再生される
7. これを10回繰り返す
8. 各回の演出映像は、前回までの結果や今回の結果によって変わる

### 演出シナリオの分岐ロジック（10連の場合）

| 回数 | 映像の長さ | 役割 |
|------|-----------|------|
| 1〜3回目 | 3〜5秒 | 短い導入演出、テンポよく |
| 4〜6回目 | 5〜8秒 | だんだん演出が長くなる、期待感UP |
| 7〜9回目 | 8〜12秒 | さらに盛り上がる演出 |
| 10回目 | 15〜20秒 | フルの演出、最後の結果にふさわしい演出 |

### 各回の演出映像の選択ルール

- 今回の結果がレア（SR以上）→ 熱い演出映像を使用
- 今回の結果がノーマル → 通常演出映像を使用
- 連続でレアが出ている → さらに熱い演出映像
- 最後の1回 → 結果に応じたフル演出

### 連続ガチャのUI

- 画面中央に演出映像
- 映像の下に大きな「NEXT」ボタン（パチスロのレバーのようなデザイン）
- 画面上部に「3/10」のような進捗表示
- 横にこれまでの結果がミニカードで並ぶ
- NEXTボタンはパチスロのSTARTレバーを模したデザイン
- ボタンを押すとレバーが下がるアニメーション

### 2連ガチャ

| 回数 | 映像の長さ |
|------|-----------|
| 1回目 | 8〜10秒 |
| 2回目 | 15〜20秒（フル演出） |

### 5連ガチャ

| 回数 | 映像の長さ |
|------|-----------|
| 1〜2回目 | 3〜5秒 |
| 3〜4回目 | 5〜8秒 |
| 5回目 | 15〜20秒（フル演出） |

## 3. デジタルカードシステム（新機能）

### カードの仕組み

- 各カードに最大発行枚数を設定（例: UR「尊師ゴールド」は10枚限定）
- ガチャで当たるとシリアルナンバー付きで発行（例: #3/10）
- 発行枚数が上限に達したカードはガチャのプールから自動除外
- ユーザーは自分のカードコレクションを閲覧できる

### カードのスタイル種別

| スタイル | 説明 |
|---------|------|
| realphoto | リアルフォト風（写真をベースに加工） |
| 3d | 3DCG風 |
| illustration | イラスト風 |
| pixel | ドット絵風 |

### カードのレア度とデフォルト確率

| レア度 | 確率 | カード枠の装飾 |
|--------|------|--------------|
| N（ノーマル） | 50% | シンプルな白枠 |
| R（レア） | 30% | 青い光沢枠 |
| SR（スーパーレア） | 15% | 紫のグロー枠 |
| SSR（ダブルスーパーレア） | 4% | 金色に輝く枠 |
| UR（ウルトラレア） | 1% | 虹色に光るアニメーション枠 |

※確率は管理者パネルから変更可能

### カード表示UI

- カードはパチスロの出目のような登場演出
- シリアルナンバーの表示（#3/10）
- レア度に応じたカード枠の装飾
- カードをタップすると拡大表示
- コレクション画面ではグリッド表示

## 4. 友達紹介機能（新機能）

### 仕組み

- ユーザーごとに一意の紹介コードを自動生成
- 紹介リンク: https://sonshigacha.com/invite/[紹介コード]
- 紹介された人が会員登録を完了 → 紹介した人にフリーチケット1枚付与
- 紹介された人にもフリーチケット1枚付与（双方にメリット）
- 紹介履歴をマイページで確認可能

### UI

- マイページに「友達を招待する」セクション
- 紹介コードのコピーボタン
- LINEやX（Twitter）への共有ボタン
- 紹介実績の一覧（紹介した人数、獲得チケット数）

## 5. LINE公式アカウント追加特典（新機能）

### 仕組み

- 「LINE公式アカウントを追加してフリーチケットGET！」ボタン
- LINEの友だち追加URLに遷移
- 追加後、LINE Webhookで検知 → フリーチケット1枚付与
- 1ユーザー1回限り

### 実装方法

- LINE Messaging API のWebhookを利用
- followイベントを検知
- ユーザーとLINEアカウントの紐付けが必要
- LINEログイン or 紐付けコードで対応

## 6. 管理者パネル（新機能）

/admin 配下に管理者専用パネルを作成する。

### ダッシュボード（/admin）
- 売上合計・本日の売上
- ユーザー数・本日の新規登録
- ガチャ回数・本日のガチャ回数
- チケット販売数
- グラフ（日別推移）

### カード管理（/admin/cards）
- カード一覧（レア度、発行状況でフィルタ）
- カードの登録・編集・削除
- 画像アップロード（Cloudflare R2）
- 発行枚数の設定・現在の発行状況確認
- 残り枚数のアラート

### カード保有者検索（/admin/cards/[id]）
- カード名で検索 → 保有者一覧
- ユーザー名で検索 → 保有カード一覧
- シリアル番号で検索
- CSV出力

### ユーザー管理（/admin/users）
- ユーザー一覧
- チケット残数確認
- チケット手動付与
- ガチャ履歴確認
- 保有カード確認

### 確率設定（/admin/probability）
- レア度別の確率変更（スライダーUI）
- 合計が100%になるようバリデーション
- RTP設定
- 天井設定
- 変更履歴

### 紹介管理（/admin/referrals）
- 紹介コードの一覧
- 紹介実績の確認
- 不正検知

## 7. 確率・RTPシステム（新機能）

### 排出確率

- レア度ごとの排出確率を管理者パネルから設定可能
- 合計100%のバリデーション
- カードのプール内での均等配分（同じレア度のカード間）

### RTP（Return To Player）

- ユーザーが使ったチケットに対して、得られたカードの価値の比率
- 管理者が目標RTPを設定可能

### 天井（Pity System）

- N回連続でSR以下の場合、次はSR以上確定
- 天井回数は管理者パネルから設定可能
- ユーザーに天井までの残り回数を表示するかは選択制

### 在庫管理

- 発行上限に達したカードはガチャプールから自動除外
- プール内のカードが0枚になった場合のフォールバック処理
- 管理者にアラート通知
